<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Public Quiz Attempt v3.0.1</title>

  <script>
    // Force page reload if version mismatch
    if (localStorage.getItem("quizVersion") !== "3.0.1") {
      localStorage.setItem("quizVersion", "3.0.1");
      if (window.location.search.indexOf("v=") === -1) {
        window.location.href =
          window.location.href + (window.location.search ? "&" : "?") + "v=3.0.1";
      }
    }
  </script>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"/>

  <!-- ✅ Awesomplete (Frappe-like link field typeahead) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.min.css"/>

  <style>
    @import url("https://fonts.googleapis.com/css2?family=Newsreader:wght@400;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap");

    :root {
      --ink: #14212f;
      --muted: #5b6776;
      --paper: #f5f1ea;
      --panel: #ffffff;
      --accent: #f36a3d;
      --accent-dark: #c9532a;
      --mint: #2b7a78;
      --shadow: 0 18px 45px rgba(20, 33, 47, 0.14);
    }

    body {
      background:
        radial-gradient(1200px 600px at 5% -10%, #fde2c6 0%, rgba(253, 226, 198, 0) 65%),
        radial-gradient(1000px 500px at 90% 0%, #cbe9e4 0%, rgba(203, 233, 228, 0) 60%),
        linear-gradient(180deg, #f6f2ec 0%, #eef3f5 100%);
      min-height: 100vh;
      font-family: "Space Grotesk", "Newsreader", sans-serif;
      color: var(--ink);
    }

    .quiz-container {
      background: var(--panel);
      border-radius: 20px;
      box-shadow: var(--shadow);
      overflow: hidden;
      border: 1px solid rgba(20, 33, 47, 0.08);
      animation: liftIn 0.5s ease;
    }

    .header-section {
      position: relative;
      background: linear-gradient(135deg, #1b2838 0%, #2f4860 100%);
      color: #ffffff;
      padding: 2.5rem 2rem 2rem;
      text-align: center;
      font-family: "Newsreader", serif;
    }

    .header-section::after {
      content: "";
      position: absolute;
      inset: 0;
      background:
        radial-gradient(300px 200px at 20% 20%, rgba(243, 106, 61, 0.35), transparent 60%),
        radial-gradient(260px 200px at 80% 10%, rgba(43, 122, 120, 0.35), transparent 60%);
      opacity: 0.65;
      pointer-events: none;
    }

    .header-section h2 {
      font-size: 32px;
      font-weight: 700;
      letter-spacing: -0.02em;
      position: relative;
      z-index: 1;
    }

    .brand-logo {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: #ffffff;
      padding: 8px;
      box-shadow: 0 12px 24px rgba(20, 33, 47, 0.25);
      object-fit: contain;
      position: relative;
      z-index: 1;
      margin-bottom: 12px;
    }

    .header-section p {
      color: rgba(255, 255, 255, 0.8);
      position: relative;
      z-index: 1;
    }

    .quiz-form {
      padding: 2rem;
      background: linear-gradient(180deg, #ffffff 0%, #fdfbf8 100%);
    }

    /* input look */
    .form-control {
      border-radius: 12px;
      border: 2px solid #e6e1d7;
      padding: 12px 15px;
      font-size: 16px;
      transition: all 0.2s ease;
      background: #fffdf9;
    }
    .form-control:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 0.2rem rgba(243, 106, 61, 0.2);
    }

    .btn-primary {
      background: linear-gradient(135deg, #f36a3d 0%, #d8582a 100%);
      border: none;
      border-radius: 12px;
      padding: 12px 30px;
      font-size: 16px;
      font-weight: 600;
      color: white;
      transition: all 0.3s ease;
      letter-spacing: 0.01em;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 28px rgba(243, 106, 61, 0.35);
    }

    .btn-secondary {
      background: #eef1f4;
      border: 1px solid #d6dde3;
      color: var(--ink);
      border-radius: 12px;
      padding: 10px 22px;
      font-weight: 600;
      transition: all 0.2s ease;
    }
    .btn-secondary:hover {
      background: #e5eaef;
      transform: translateY(-1px);
    }

    .quiz-list {
      background: #f8f4ec;
      border-radius: 14px;
      padding: 1.5rem;
      margin-top: 1rem;
      border: 1px solid rgba(20, 33, 47, 0.08);
    }
    .quiz-item {
      background: white;
      border-radius: 14px;
      padding: 1.25rem;
      margin-bottom: 1rem;
      border: 1px solid #ece6dc;
      transition: all 0.3s ease;
    }
    .quiz-item:hover {
      box-shadow: 0 10px 20px rgba(20, 33, 47, 0.12);
      transform: translateY(-2px);
    }
    .quiz-title {
      font-weight: 700;
      color: var(--ink);
      margin-bottom: 0.5rem;
      font-family: "Newsreader", serif;
      font-size: 20px;
    }
    .quiz-details { color: var(--muted); font-size: 14px; }

    .btn-attempt {
      background: linear-gradient(135deg, #2b7a78 0%, #206460 100%);
      border: none;
      border-radius: 10px;
      padding: 10px 18px;
      font-size: 14px;
      font-weight: 600;
      color: white;
      transition: all 0.3s ease;
    }
    .btn-attempt:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 18px rgba(43, 122, 120, 0.35);
    }

    .loading { display: none; }
    .spinner-border-sm { width: 1rem; height: 1rem; }

    .error-message {
      background: #ffe4de;
      color: #8a2b1d;
      padding: 1rem;
      border-radius: 12px;
      margin-top: 1rem;
      display: none;
      border: 1px solid rgba(243, 106, 61, 0.3);
    }
    .success-message {
      background: #e0f2f1;
      color: #1d5450;
      padding: 1rem;
      border-radius: 12px;
      margin-top: 1rem;
      display: none;
      border: 1px solid rgba(43, 122, 120, 0.3);
    }

    .no-quizzes {
      text-align: center;
      color: var(--muted);
      padding: 2rem;
    }

    .question-card {
      background: #ffffff;
      border: 1px solid #ece6dc;
      border-radius: 16px;
      box-shadow: 0 10px 24px rgba(20, 33, 47, 0.08);
    }

    .question-title {
      font-size: 16px;
      color: var(--ink);
    }

    .option-item {
      border: 1px solid #ece6dc;
      border-radius: 12px;
      transition: all 0.2s ease;
      background: #fffdf9;
    }

    .option-item.selected {
      border-color: var(--accent);
      background: #fff1ea;
      box-shadow: 0 6px 16px rgba(243, 106, 61, 0.18);
    }

    .badge.bg-primary {
      background-color: var(--accent) !important;
      color: #fff;
    }

    .quiz-info-row {
      background: #f7f1e7;
      border-radius: 16px;
      border: 1px solid #ece6dc;
    }

    .question-progress {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      background: #f6efe4;
      border-radius: 12px;
      padding: 10px 14px;
      border: 1px solid #ece6dc;
      font-weight: 600;
      color: var(--ink);
    }

    .question-nav {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-top: 18px;
    }

    .review-card,
    .history-card {
      background: #ffffff;
      border-radius: 16px;
      border: 1px solid #ece6dc;
      box-shadow: 0 10px 24px rgba(20, 33, 47, 0.08);
      padding: 1.25rem;
      margin-bottom: 1.25rem;
    }

    .review-item {
      border-bottom: 1px solid #f0e8dd;
      padding: 0.75rem 0;
    }

    .review-item:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }

    .answer-pill {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      background: #e8f3f2;
      color: #1d5450;
      font-size: 12px;
      font-weight: 600;
    }

    .answer-pill.unanswered {
      background: #ffe4de;
      color: #8a2b1d;
    }

    .history-item {
      border-bottom: 1px dashed #e2d8c8;
      padding: 0.75rem 0;
    }

    .history-item:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }

    .result-card {
      background: #ffffff;
      border-radius: 18px;
      border: 1px solid #ece6dc;
      box-shadow: 0 12px 28px rgba(20, 33, 47, 0.12);
    }

    @keyframes liftIn {
      from {
        transform: translateY(18px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    /* ✅ Awesomplete dropdown styling to look like Frappe */
    .awesomplete {
      width: 100%;
      display: block;
    }
    .awesomplete > ul {
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.12);
      max-height: 260px;
      overflow: auto;
      margin-top: 6px;
      padding: 6px;
      background: #fff;
      z-index: 9999;
    }
    .awesomplete > ul > li {
      border-radius: 8px;
      padding: 10px 10px;
      font-size: 14px;
    }
    .awesomplete > ul > li[aria-selected="true"] {
      background: #eef2ff;
      color: #111827;
    }

    /* small helper text like frappe "type to search" */
    .hint {
      font-size: 12px;
      color: #6b7280;
      margin-top: 6px;
    }
  </style>
</head>

<body>
  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-md-10 col-lg-8">
        <div class="quiz-container" id="mainQuizContainer">
          <div class="header-section">
            <img class="brand-logo" src="https://erp.nutc.cloud/files/nutclogo.jpg" alt="NUTC Logo">
            <h2 class="mb-0">Public Quiz Attempt</h2>
            <p class="mb-0">Select your student group and student to attempt quizzes</p>
          </div>

          <div class="quiz-form" id="quizForm">
            <form id="studentSelectionForm" novalidate>
              <!-- Filter Section -->
              <div class="row mb-4">
                <div class="col-12">
                  <h5 class="mb-3"><i class="fas fa-filter me-2"></i>Filter Options</h5>
                </div>

                <!-- Academic Year (Frappe-like Link Field UI) -->
                <div class="col-md-3 mb-3">
                  <label class="form-label">
                    <i class="fas fa-calendar-alt me-2"></i>Academic Year
                  </label>
                  <input type="text" class="form-control" id="academicYearTxt" placeholder="All Academic Years" autocomplete="off">
                  <input type="hidden" id="academicYearVal" value="">
                  <div class="hint">Type to search</div>
                </div>

                <!-- Course -->
                <div class="col-md-3 mb-3">
                  <label class="form-label">
                    <i class="fas fa-graduation-cap me-2"></i>Course
                  </label>
                  <input type="text" class="form-control" id="courseTxt" placeholder="All Courses" autocomplete="off">
                  <input type="hidden" id="courseVal" value="">
                  <div class="hint">Type to search</div>
                </div>

                <div class="col-md-3 mb-3">
                  <label for="fromDate" class="form-label">
                    <i class="fas fa-calendar me-2"></i>From Date
                  </label>
                  <input type="date" class="form-control" id="fromDate">
                </div>

                <div class="col-md-3 mb-3">
                  <label for="toDate" class="form-label">
                    <i class="fas fa-calendar me-2"></i>To Date
                  </label>
                  <input type="date" class="form-control" id="toDate">
                </div>
              </div>

              <!-- Student Selection -->
              <div class="row mb-4">
                <div class="col-12">
                  <h5 class="mb-3"><i class="fas fa-users me-2"></i>Student Selection</h5>
                </div>

                <div class="col-md-6 mb-3">
                  <label class="form-label">
                    <i class="fas fa-users me-2"></i>Student Group
                  </label>
                  <input type="text" class="form-control" id="studentGroupTxt" placeholder="Select Student Group" autocomplete="off" disabled>
                  <input type="hidden" id="studentGroupVal" value="">
                  <div class="hint">Type to search</div>
                </div>

                <div class="col-md-6 mb-3">
                  <label class="form-label">
                    <i class="fas fa-user me-2"></i>Student
                  </label>
                  <input type="text" class="form-control" id="studentTxt" placeholder="Select Student" autocomplete="off" disabled>
                  <input type="hidden" id="studentVal" value="">
                  <div class="hint">Type to search</div>
                </div>
              </div>

              <div class="d-grid">
                <button type="submit" class="btn btn-primary" id="loadQuizzesBtn">
                  <span class="btn-text"><i class="fas fa-search me-2"></i>Load Available Quizzes</span>
                  <span class="loading"><span class="spinner-border spinner-border-sm me-2"></span>Loading...</span>
                </button>
              </div>
            </form>

            <div class="error-message" id="errorMessage">
              <i class="fas fa-exclamation-triangle me-2"></i>
              <span id="errorText"></span>
            </div>

            <div class="success-message" id="successMessage">
              <i class="fas fa-check-circle me-2"></i>
              <span id="successText"></span>
            </div>

            <div class="quiz-list" id="quizList" style="display:none;">
              <h5 class="mb-3"><i class="fas fa-list me-2"></i>Available Quizzes</h5>
              <div id="quizItems"></div>
            </div>

            <div class="no-quizzes" id="noQuizzes" style="display:none;">
              <i class="fas fa-info-circle fa-2x mb-3"></i>
              <p>No quizzes available for the selected student group and student.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.min.js"></script>

 <script>
  const VERSION = "3.0.1";

  // ====== Data caches ======
  let academicYearsData = [];   // [{value,label}]
  let coursesData = [];         // [{value,label}]
  let studentGroupsData = [];   // [{value,label}]
  let studentsData = [];        // [{value,label}]
  let quizAttemptState = null;
  let preselectParams = null;

  function getPreselectParams() {
    const params = new URLSearchParams(window.location.search || "");
    const studentGroup = params.get("student_group");
    const student = params.get("student");
    if (!studentGroup && !student) return null;
    return {
      studentGroup,
      studentGroupLabel: params.get("student_group_label") || "",
      student,
      studentName: params.get("student_name") || "",
      autoStart: params.get("autostart") === "1"
    };
  }

  function initQuizAttemptState(quizData, quizName, student, studentGroup, history) {
    quizAttemptState = {
      quizData,
      quizName,
      student,
      studentGroup,
      history: history || [],
      currentIndex: 0,
      answers: {}
    };
  }

  function setAnswer(questionName, optionId) {
    if (!quizAttemptState) return;
    quizAttemptState.answers[questionName] = optionId;
  }

  function getAnswer(questionName) {
    if (!quizAttemptState) return null;
    return quizAttemptState.answers[questionName] || null;
  }

  function getSelectedOptionText(question, optionId) {
    if (!optionId) return "";
    const match = question.options.find((opt) => opt.id === optionId);
    return match ? match.text : "";
  }

  function debounce(fn, delay = 250) {
    let t = null;
    return (...args) => {
      clearTimeout(t);
      t = setTimeout(() => fn(...args), delay);
    };
  }

  // ====== Frappe-like Link Field (Awesomplete) ======
  function makeLinkField({ txtId, valId, placeholder, getItems, onSelect }) {
    const txtEl = document.getElementById(txtId);
    const valEl = document.getElementById(valId);

    txtEl.setAttribute("placeholder", placeholder || "");

    const lf = {
      txtEl,
      valEl,
      lastItems: [],
      aw: null,
      setList(items) {
        lf.lastItems = items || [];
        lf.aw.list = lf.lastItems.map(x => x.label);
      },
      clear() {
        txtEl.value = "";
        valEl.value = "";
      },
      setDisabled(disabled) {
        txtEl.disabled = !!disabled;
      }
    };

    lf.aw = new Awesomplete(txtEl, {
      minChars: 0,
      autoFirst: true,
      maxItems: 50
    });

    const refresh = debounce(async () => {
      const q = txtEl.value || "";
      const items = await getItems(q);
      lf.setList(items);
      lf.aw.evaluate(); // open dropdown
    }, 200);

    txtEl.addEventListener("input", refresh);
    txtEl.addEventListener("focus", refresh);
    txtEl.addEventListener("click", refresh);


    txtEl.addEventListener("awesomplete-selectcomplete", (evt) => {
      const selectedLabel = evt?.text?.value || txtEl.value;

      const found = lf.lastItems.find(x => x.label === selectedLabel);
      if (found) {
        txtEl.value = found.label;
        valEl.value = found.value;
      } else {
        valEl.value = "";
      }

      if (typeof onSelect === "function") {
        onSelect({ label: txtEl.value, value: valEl.value });
      }
    });

    // If user types random text and leaves, clear value (like frappe)
    txtEl.addEventListener("blur", () => {
      const exact = lf.lastItems.find(x => x.label === txtEl.value);
      if (!exact && txtEl.value) {
        // user typed something not selected
        valEl.value = "";
      }
    });

    return lf;
  }

  // ====== API fetchers ======
  async function fetchAcademicYears() {
    const res = await fetch("/api/method/numerouno.numerouno.api.quiz_api.get_academic_years");
    const data = await res.json();
    if (data.message?.status !== "success") return [];
    return (data.message.academic_years || []).map(y => ({
      value: y.name,
      label: y.academic_year
    }));
  }

  async function fetchCourses() {
    const res = await fetch("/api/method/numerouno.numerouno.api.quiz_api.get_courses");
    const data = await res.json();
    if (data.message?.status !== "success") return [];
    return (data.message.courses || []).map(c => ({
      value: c.name,
      label: c.course_name
    }));
  }

  async function fetchStudentGroupsFiltered() {
    const academicYear = document.getElementById("academicYearVal").value;
    const course = document.getElementById("courseVal").value;
    const fromDate = document.getElementById("fromDate").value;
    const toDate = document.getElementById("toDate").value;

    let url = "/api/method/numerouno.numerouno.api.quiz_api.get_student_groups";
    const params = new URLSearchParams();
    if (academicYear) params.append("academic_year", academicYear);
    if (course) params.append("course", course);
    if (fromDate) params.append("from_date", fromDate);
    if (toDate) params.append("to_date", toDate);
    if (params.toString()) url += "?" + params.toString();

    const res = await fetch(url);
    const data = await res.json();
    if (data.message?.status !== "success") return [];

    return (data.message.student_groups || []).map(g => ({
      value: g.name,
      label: `${g.student_group_name} (${g.course})`
    }));
  }

  async function fetchStudentsByGroup(studentGroupName) {
    const url =
      `/api/method/numerouno.numerouno.api.quiz_api.get_students_by_group` +
      `?student_group=${encodeURIComponent(studentGroupName)}`;
    const res = await fetch(url);
    const data = await res.json();
    if (data.message?.status !== "success") return [];
    return (data.message.students || []).map(s => ({
      value: s.student,
      label: s.student_name
    }));
  }

  async function fetchQuizSubmissionHistory(student, quizName) {
    const params = new URLSearchParams();
    params.append("student", student);
    if (quizName) params.append("quiz_name", quizName);
    params.append("limit", "5");
    const url = `/api/method/numerouno.numerouno.api.quiz_api.get_quiz_submission_history?${params.toString()}`;
    const res = await fetch(url);
    const data = await res.json();
    if (data.message?.status !== "success") return [];
    return data.message.history || [];
  }

  // ====== UI helpers ======
  function showLoading(show) {
    const btn = document.getElementById("loadQuizzesBtn");
    const btnText = btn.querySelector(".btn-text");
    const loading = btn.querySelector(".loading");
    if (show) {
      btn.disabled = true;
      btnText.style.display = "none";
      loading.style.display = "inline-block";
    } else {
      btn.disabled = false;
      btnText.style.display = "inline-block";
      loading.style.display = "none";
    }
  }

  function showError(message) {
    document.getElementById("errorText").textContent = message;
    document.getElementById("errorMessage").style.display = "block";
    document.getElementById("successMessage").style.display = "none";
  }

  function showSuccess(message) {
    document.getElementById("successText").textContent = message;
    document.getElementById("successMessage").style.display = "block";
    document.getElementById("errorMessage").style.display = "none";
  }

  function hideMessages() {
    document.getElementById("errorMessage").style.display = "none";
    document.getElementById("successMessage").style.display = "none";
  }

  // ====== Link fields ======
  let academicYearLF, courseLF, studentGroupLF, studentLF;

  document.addEventListener("DOMContentLoaded", async () => {
    preselectParams = getPreselectParams();
    // init fields
    academicYearLF = makeLinkField({
      txtId: "academicYearTxt",
      valId: "academicYearVal",
      placeholder: "All Academic Years",
      getItems: async (q) => {
        const qq = (q || "").toLowerCase();
        return academicYearsData.filter(x => x.label.toLowerCase().includes(qq));
      },
      onSelect: () => reloadStudentGroups()
    });

    courseLF = makeLinkField({
      txtId: "courseTxt",
      valId: "courseVal",
      placeholder: "All Courses",
      getItems: async (q) => {
        const qq = (q || "").toLowerCase();
        return coursesData.filter(x => x.label.toLowerCase().includes(qq));
      },
      onSelect: () => reloadStudentGroups()
    });

    studentGroupLF = makeLinkField({
      txtId: "studentGroupTxt",
      valId: "studentGroupVal",
      placeholder: "Select Student Group",
      getItems: async (q) => {
        const qq = (q || "").toLowerCase();
        return studentGroupsData.filter(x => x.label.toLowerCase().includes(qq));
      },
      onSelect: async ({ value }) => reloadStudents(value)
    });

    studentLF = makeLinkField({
      txtId: "studentTxt",
      valId: "studentVal",
      placeholder: "Select Student",
      getItems: async (q) => {
        const qq = (q || "").toLowerCase();
        return studentsData.filter(x => x.label.toLowerCase().includes(qq));
      }
    });

    // initial disable states
    // studentGroupLF.setDisabled(true);
    studentLF.setDisabled(true);

    // load base datasets
    academicYearsData = await fetchAcademicYears();
    coursesData = await fetchCourses();

    // load student groups initially (based on empty filters)
    await reloadStudentGroups();
    await applyPreselectIfAny();

    // filter change events
    document.getElementById("fromDate").addEventListener("change", reloadStudentGroups);
    document.getElementById("toDate").addEventListener("change", reloadStudentGroups);

    // submit
    document.getElementById("studentSelectionForm").addEventListener("submit", (e) => {
      e.preventDefault();
      loadQuizzes();
    });
  });

  // ====== reload groups/students ======
//   async function reloadStudentGroups() {
//     showLoading(true);
//     hideMessages();

//     // reset dependent fields like frappe
//     studentGroupLF.clear();
//     studentLF.clear();
//     document.getElementById("studentTxt").disabled = true;
//     // document.getElementById("studentGroupTxt").disabled = true;
//     studentsData = [];

//     try {
//       studentGroupsData = await fetchStudentGroupsFiltered();
//       showLoading(false);

//       if (studentGroupsData.length) {
//         document.getElementById("studentGroupTxt").disabled = false;
//         showSuccess("Student groups loaded. Type to search.");
//       } else {
//         showError("No student groups found for selected filters.");
//       }
//     } catch (e) {
//       showLoading(false);
//       showError("Error loading student groups. Please try again.");
//       console.error(e);
//     }
//   }

async function reloadStudentGroups() {
  showLoading(true);
  hideMessages();

  // reset dependent fields
  studentGroupLF.clear();
  studentLF.clear();
  document.getElementById("studentTxt").disabled = true;
  studentsData = [];

  try {
    studentGroupsData = await fetchStudentGroupsFiltered();
    showLoading(false);

    // ✅ Always enable student group (even if filters empty)
    document.getElementById("studentGroupTxt").disabled = false;

    if (studentGroupsData.length) {
      showSuccess("Student groups loaded. Type to search.");
    } else {
      showError("No student groups found (try different filters).");
    }
  } catch (e) {
    showLoading(false);
    document.getElementById("studentGroupTxt").disabled = false;
    showError("Error loading student groups. Please try again.");
    console.error(e);
  }
}

  async function applyPreselectIfAny() {
    if (!preselectParams) return;

    const { studentGroup, studentGroupLabel, student, studentName, autoStart } = preselectParams;
    if (studentGroup) {
      const groupMatch = studentGroupsData.find((x) => x.value === studentGroup);
      document.getElementById("studentGroupTxt").value =
        studentGroupLabel || groupMatch?.label || studentGroup;
      document.getElementById("studentGroupVal").value = studentGroup;
      await reloadStudents(studentGroup);
    }

    if (student) {
      const studentMatch = studentsData.find((x) => x.value === student);
      document.getElementById("studentTxt").value =
        studentName || studentMatch?.label || student;
      document.getElementById("studentVal").value = student;
      document.getElementById("studentTxt").disabled = false;
    }

    if (autoStart && studentGroup && student) {
      loadQuizzes();
    }

    preselectParams = null;
  }


  async function reloadStudents(studentGroupName) {
    if (!studentGroupName) return;

    showLoading(true);
    hideMessages();

    studentLF.clear();
    studentsData = [];
    document.getElementById("studentTxt").disabled = true;

    try {
      studentsData = await fetchStudentsByGroup(studentGroupName);
      showLoading(false);

      if (studentsData.length) {
        document.getElementById("studentTxt").disabled = false;
        showSuccess("Students loaded. Type to search.");
      } else {
        showError("No students found in this group.");
      }
    } catch (e) {
      showLoading(false);
      showError("Error loading students. Please try again.");
      console.error(e);
    }
  }

  // ====== quizzes ======
  function loadQuizzes() {
    const studentGroup = document.getElementById("studentGroupVal").value;
    const student = document.getElementById("studentVal").value;

    if (!studentGroup || !student) {
      showError("Please select Student Group and Student from suggestions.");
      return;
    }

    showLoading(true);
    hideMessages();

    const url =
      `/api/method/numerouno.numerouno.api.quiz_api.get_available_quizzes_from_mcqs` +
      `?student_group=${encodeURIComponent(studentGroup)}&student=${encodeURIComponent(student)}`;

    console.log("=".repeat(80));
    console.log("LOADING QUIZZES - Frontend Debug");
    console.log("Student Group:", studentGroup);
    console.log("Student:", student);
    console.log("API URL:", url);
    console.log("=".repeat(80));
    
    fetch(url, { method: "GET", headers: { "Content-Type": "application/json" } })
      .then((r) => r.json())
      .then((data) => {
        showLoading(false);
        console.log("=".repeat(80));
        console.log("QUIZ API RESPONSE - Full Data:");
        console.log(JSON.stringify(data, null, 2));
        console.log("=".repeat(80));
        
        if (data.message?.status === "success") {
          const quizzes = data.message.quizzes || [];
          const debugInfo = data.message.debug_info || {};
          
          console.log("Quizzes found:", quizzes.length);
          console.log("Debug Info:", debugInfo);
          
          if (quizzes.length === 0) {
            const debugMsg = data.message.debug || "No quizzes available";
            const debugDetails = data.message.debug_details || {};
            
            console.error("NO QUIZZES FOUND!");
            console.error("Debug Message:", debugMsg);
            console.error("Debug Details:", debugDetails);
            
            let errorMsg = `${debugMsg}. `;
            if (debugDetails.quiz_names_from_mcqs && debugDetails.quiz_names_from_mcqs.length > 0) {
              errorMsg += `Quiz names found in MCQS Assignment: ${debugDetails.quiz_names_from_mcqs.join(", ")}. `;
            }
            if (debugDetails.assignments_found !== undefined) {
              errorMsg += `MCQS Assignments found: ${debugDetails.assignments_found}. `;
            }
            errorMsg += `Please check that MCQS Assignment exists for student group: ${studentGroup} and has quizzes linked.`;
            
            showError(errorMsg);
          } else {
            console.log("Quizzes to display:", quizzes);
            displayQuizzes(quizzes);
            showSuccess("Quizzes loaded successfully!");
          }
        } else {
          const errorMsg = data.message?.message || data.message?.debug || "Failed to load quizzes";
          console.error("API Error:", errorMsg);
          console.error("Full error response:", data.message);
          showError(errorMsg);
        }
      })
      .catch((err) => {
        showLoading(false);
        console.error("=".repeat(80));
        console.error("FETCH ERROR:");
        console.error(err);
        console.error("=".repeat(80));
        showError("Error loading quizzes. Please try again. Check browser console for details.");
      });
  }

  function displayQuizzes(quizzes) {
    const quizList = document.getElementById("quizList");
    const quizItems = document.getElementById("quizItems");
    const noQuizzes = document.getElementById("noQuizzes");

    if (!quizzes || quizzes.length === 0) {
      quizList.style.display = "none";
      noQuizzes.style.display = "block";
      return;
    }

    quizItems.innerHTML = "";
    quizzes.forEach((quiz) => {
      const totalMarks = 100;
      const quizItem = document.createElement("div");
      quizItem.className = "quiz-item";
      quizItem.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <div class="quiz-title">${quiz.title}</div>
            <div class="quiz-details">
              <i class="fas fa-star me-1"></i>Total Marks: ${totalMarks}
              <span class="ms-3">
                <i class="fas fa-percentage me-1"></i>Passing: ${quiz.passing_percentage || "N/A"}%
              </span>
              <span class="ms-3">
                <i class="fas fa-clock me-1"></i>Max Attempts: ${quiz.max_attempts || "Unlimited"}
              </span>
            </div>
          </div>
          <button class="btn btn-attempt" onclick="attemptQuiz('${quiz.name}', '${(quiz.title || "").replaceAll("'", "\\'")}')">
            <i class="fas fa-play me-1"></i>Attempt Quiz
          </button>
        </div>
      `;
      quizItems.appendChild(quizItem);
    });

    quizList.style.display = "block";
    noQuizzes.style.display = "none";
  }

  // ====== Quiz Attempt Flow ======
  function attemptQuiz(quizName, quizTitle) {
    const studentGroup = document.getElementById("studentGroupVal").value;
    const student = document.getElementById("studentVal").value;
    const studentName = document.getElementById("studentTxt").value || student;
    const studentGroupLabel = document.getElementById("studentGroupTxt").value || studentGroup;
    
    if (!studentGroup || !student) {
      showError("Please select student group and student first");
      return;
    }

    loadQuizForAttempt(quizName, quizTitle, student, studentGroup, studentName, studentGroupLabel);
  }

  function loadQuizForAttempt(quizName, quizTitle, student, studentGroup, studentName, studentGroupLabel) {
    showLoading(true);
    hideMessages();

    const url = `/api/method/numerouno.numerouno.api.quiz_api.get_quiz_questions_from_quiz?quiz_name=${encodeURIComponent(quizName)}`;
    
    fetch(url, {
      method: "GET",
      headers: { "Content-Type": "application/json" }
    })
      .then((r) => r.json())
      .then((data) => {
        showLoading(false);
        console.log("=".repeat(80));
        console.log("QUIZ QUESTIONS API RESPONSE - Full Data:");
        console.log(JSON.stringify(data, null, 2));
        console.log("Questions count:", data.message?.questions?.length || 0);
        console.log("=".repeat(80));
        if (data.message?.status === "success") {
          displayQuizForAttempt(data.message, quizName, student, studentGroup, studentName, studentGroupLabel);
        } else {
          showError(data.message?.message || "Failed to load quiz");
        }
      })
      .catch((err) => {
        showLoading(false);
        showError("Error loading quiz. Please try again.");
        console.error(err);
      });
  }

  function displayQuizForAttempt(quizData, quizName, student, studentGroup, studentName, studentGroupLabel) {
    // Hide the form and show quiz
    document.getElementById("quizForm").style.display = "none";
    document.getElementById("quizList").style.display = "none";
    document.getElementById("noQuizzes").style.display = "none";
    const mainContainer = document.getElementById("mainQuizContainer");
    if (mainContainer) {
      mainContainer.style.display = "none";
    }
    
    // Create quiz container
    const quizContainer = document.createElement("div");
    quizContainer.id = "quizAttemptContainer";
    quizContainer.innerHTML = `
      <div class="quiz-container">
        <div class="header-section">
          <img class="brand-logo" src="https://erp.nutc.cloud/files/nutclogo.jpg" alt="NUTC Logo">
          <h2 class="mb-0">${quizData.quiz.title}</h2>
          <p class="mb-0">Student: ${studentName} | Group: ${studentGroupLabel}</p>
        </div>
        <div class="quiz-form">
          <div class="quiz-content" id="quizContent">
            <div class="text-center">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-3">Loading Quiz...</p>
            </div>
          </div>
          <div class="text-center mt-3">
            <button class="btn btn-secondary" onclick="goBackToQuizList()">
              <i class="fas fa-arrow-left me-2"></i>Back to Quiz List
            </button>
          </div>
        </div>
      </div>
    `;
    
    // Insert quiz container after the main container
    const mainContainerNode = document.querySelector(".quiz-container");
    mainContainerNode.parentNode.insertBefore(quizContainer, mainContainerNode.nextSibling);
    
    // Load quiz questions with history
    setTimeout(async () => {
      const history = await fetchQuizSubmissionHistory(student, quizName);
      displayQuizQuestions(quizData, quizName, student, studentGroup, history);
    }, 500);
  }

  function displayQuizQuestions(quizData, quizName, student, studentGroup, history) {
    const quizContent = document.getElementById("quizContent");
    quizContent.innerHTML = "";
    const totalMarks = 100;

    initQuizAttemptState(quizData, quizName, student, studentGroup, history);

    // Quiz info
    const quizInfo = document.createElement("div");
    quizInfo.className = "mb-4 p-3 quiz-info-row";
    quizInfo.innerHTML = `
      <div class="row text-center">
        <div class="col-md-3"><strong>Total Marks:</strong> ${totalMarks}</div>
        <div class="col-md-3"><strong>Passing %:</strong> ${quizData.quiz.passing_percentage}%</div>
        <div class="col-md-3"><strong>Max Attempts:</strong> ${quizData.quiz.max_attempts || "Unlimited"}</div>
        <div class="col-md-3"><strong>Questions:</strong> ${quizData.questions.length}</div>
      </div>
    `;
    quizContent.appendChild(quizInfo);

    const progressRow = document.createElement("div");
    progressRow.className = "question-progress mb-3";
    progressRow.id = "questionProgress";
    quizContent.appendChild(progressRow);

    // Submission history disabled
    // const historyContainer = document.createElement("div");
    // historyContainer.id = "historyContainer";
    // quizContent.appendChild(historyContainer);

    const stageContainer = document.createElement("div");
    stageContainer.id = "questionStage";
    quizContent.appendChild(stageContainer);

    const navContainer = document.createElement("div");
    navContainer.id = "navStage";
    quizContent.appendChild(navContainer);

    const reviewContainer = document.createElement("div");
    reviewContainer.id = "reviewStage";
    reviewContainer.style.display = "none";
    quizContent.appendChild(reviewContainer);

    // renderHistorySection();
    renderQuestionView();
  }

  // Submission history disabled

  function renderQuestionView() {
    if (!quizAttemptState) return;
    const { quizData, currentIndex } = quizAttemptState;
    const questions = quizData.questions || [];
    const question = questions[currentIndex];
    const progress = document.getElementById("questionProgress");
    const stage = document.getElementById("questionStage");
    const nav = document.getElementById("navStage");
    const reviewStage = document.getElementById("reviewStage");

    if (!question || !stage || !nav || !progress) return;

    reviewStage.style.display = "none";
    stage.style.display = "block";
    nav.style.display = "block";

    const answeredCount = questions.filter((q) => !!getAnswer(q.name)).length;
    progress.innerHTML = `
      <span>Question ${currentIndex + 1} of ${questions.length}</span>
      <span>Answered ${answeredCount} / ${questions.length}</span>
    `;

    const selectedId = getAnswer(question.name);
    stage.innerHTML = `
      <div class="question-card mb-4 p-3">
        <div class="question-title mb-3">
          <strong>Question ${currentIndex + 1}:</strong> ${question.question}
          <span class="badge bg-primary ms-2">${question.marks} mark${question.marks > 1 ? "s" : ""}</span>
        </div>
        <div class="options" data-question="${question.name}">
          ${question.options.map(option => `
            <div class="option-item mb-2 p-2 cursor-pointer ${selectedId === option.id ? "selected" : ""}" data-option="${option.id}" style="cursor: pointer;">
              <input type="radio" name="question_${question.name}" value="${option.id}" id="q${question.name}_${option.id}" ${selectedId === option.id ? "checked" : ""}>
              <label for="q${question.name}_${option.id}" class="ms-2 cursor-pointer" style="cursor: pointer;">${option.text}</label>
            </div>
          `).join("")}
        </div>
      </div>
    `;

    stage.querySelectorAll(".option-item").forEach((item) => {
      item.addEventListener("click", function() {
        const questionName = this.closest(".options").dataset.question;
        const optionId = parseInt(this.dataset.option, 10);
        setAnswer(questionName, optionId);

        this.closest(".options").querySelectorAll(".option-item").forEach((opt) => {
          opt.classList.remove("selected");
          opt.querySelector('input[type="radio"]').checked = false;
        });

        this.classList.add("selected");
        this.querySelector('input[type="radio"]').checked = true;
      });
    });

    const isFirst = currentIndex === 0;
    const isLast = currentIndex === questions.length - 1;

    nav.innerHTML = `
      <div class="question-nav">
        <button class="btn btn-secondary" id="prevQuestionBtn" ${isFirst ? "disabled" : ""}>
          <i class="fas fa-arrow-left me-2"></i>Previous
        </button>
        <button class="btn btn-primary" id="nextQuestionBtn">
          ${isLast ? '<i class="fas fa-clipboard-list me-2"></i>Review Answers' : '<i class="fas fa-arrow-right me-2"></i>Next'}
        </button>
        <button class="btn btn-secondary" id="reviewAnswersBtn">
          <i class="fas fa-eye me-2"></i>Review
        </button>
      </div>
    `;

    const prevBtn = document.getElementById("prevQuestionBtn");
    const nextBtn = document.getElementById("nextQuestionBtn");
    const reviewBtn = document.getElementById("reviewAnswersBtn");

    if (prevBtn) {
      prevBtn.addEventListener("click", () => {
        if (quizAttemptState.currentIndex > 0) {
          quizAttemptState.currentIndex -= 1;
          renderQuestionView();
        }
      });
    }

    if (nextBtn) {
      nextBtn.addEventListener("click", () => {
        const selected = getAnswer(question.name);
        if (!selected) {
          showError("Please select an answer before continuing.");
          return;
        }
        hideMessages();
        if (isLast) {
          renderReviewView();
        } else {
          quizAttemptState.currentIndex += 1;
          renderQuestionView();
        }
      });
    }

    if (reviewBtn) {
      reviewBtn.addEventListener("click", () => {
        renderReviewView();
      });
    }
  }

  function renderReviewView() {
    if (!quizAttemptState) return;
    const { quizData } = quizAttemptState;
    const questions = quizData.questions || [];
    const stage = document.getElementById("questionStage");
    const nav = document.getElementById("navStage");
    const reviewStage = document.getElementById("reviewStage");
    const progress = document.getElementById("questionProgress");

    if (!reviewStage || !progress) return;

    stage.style.display = "none";
    nav.style.display = "none";
    reviewStage.style.display = "block";

    progress.innerHTML = `
      <span>Review Answers</span>
      <span>Total Questions: ${questions.length}</span>
    `;

    reviewStage.innerHTML = `
      <div class="review-card">
        <h5 class="mb-3"><i class="fas fa-clipboard-check me-2"></i>Preview Answers</h5>
        ${questions.map((question, index) => {
          const selectedId = getAnswer(question.name);
          const selectedText = getSelectedOptionText(question, selectedId);
          return `
            <div class="review-item">
              <div class="d-flex justify-content-between align-items-center flex-wrap">
                <div>
                  <strong>Q${index + 1}.</strong> ${question.question}
                  <div class="mt-1">
                    <span class="answer-pill ${selectedId ? "" : "unanswered"}">
                      ${selectedId ? selectedText : "Unanswered"}
                    </span>
                  </div>
                </div>
                <button class="btn btn-secondary btn-sm mt-2" data-edit-index="${index}">
                  <i class="fas fa-edit me-1"></i>Edit
                </button>
              </div>
            </div>
          `;
        }).join("")}
        <div class="question-nav mt-3">
          <button class="btn btn-secondary" id="backToQuestionsBtn">
            <i class="fas fa-arrow-left me-2"></i>Back to Questions
          </button>
          <button class="btn btn-primary btn-lg" id="submitQuizBtn">
            <span class="submit-text"><i class="fas fa-paper-plane me-2"></i>Submit Quiz</span>
            <span class="loading" style="display:none;"><span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Submitting...</span>
          </button>
        </div>
      </div>
    `;

    reviewStage.querySelectorAll("[data-edit-index]").forEach((btn) => {
      btn.addEventListener("click", () => {
        const idx = parseInt(btn.dataset.editIndex, 10);
        quizAttemptState.currentIndex = idx;
        renderQuestionView();
      });
    });

    const backBtn = document.getElementById("backToQuestionsBtn");
    if (backBtn) {
      backBtn.addEventListener("click", () => {
        renderQuestionView();
      });
    }

    const submitBtn = document.getElementById("submitQuizBtn");
    if (submitBtn) {
      submitBtn.addEventListener("click", () => {
        submitQuiz(quizAttemptState.quizData, quizAttemptState.quizName, quizAttemptState.student, quizAttemptState.studentGroup);
      });
    }
  }
  function submitQuiz(quizData, quizName, student, studentGroup) {
    const submitBtn = document.getElementById("submitQuizBtn");
    if (submitBtn && submitBtn.disabled) {
      return;
    }
    // Collect answers
    const answers = {};
    (quizData.questions || []).forEach((question) => {
      const selected = getAnswer(question.name);
      answers[question.name] = selected ? [selected] : [];
    });

    // Check if all questions are answered
    const unansweredQuestions = Object.keys(answers).filter((q) => answers[q].length === 0);
    if (unansweredQuestions.length > 0) {
      showError(`Please answer all questions. ${unansweredQuestions.length} question(s) remaining.`);
      return;
    }

    // Prepare submission data
    const submissionAnswers = quizData.questions.map((question) => {
      const answer = answers[question.name] || [];
      return {
        question: question.name,
        answers: answer,
        marks: question.marks
      };
    });

    showLoading(true);
    hideMessages();
    setSubmitLoading(true);

    // Submit quiz - Use POST to avoid URL length limits
    console.log("=".repeat(80));
    console.log("SUBMITTING QUIZ");
    console.log("Quiz:", quizName);
    console.log("Student:", student);
    console.log("Student Group:", studentGroup);
    console.log("Answers:", submissionAnswers);
    console.log("=".repeat(80));
    
    // Build payload (POST to avoid 414 URI too long)
    const params = new URLSearchParams();
    params.append("quiz_name", quizName);
    params.append("student", student);
    params.append("student_group", studentGroup);
    params.append("answers", JSON.stringify(submissionAnswers));
    
    const url = "/api/method/numerouno.numerouno.api.quiz_api.submit_quiz_from_mcqs";
    
    console.log("Submitting quiz via POST:", url);
    
    fetch(url, {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8",
        "Accept": "application/json"
      },
      body: params.toString()
    })
      .then((r) => {
        if (!r.ok) {
          throw new Error(`HTTP error! status: ${r.status}`);
        }
        return r.json();
      })
      .then((data) => {
        showLoading(false);
        console.log("Submission response:", data);
        if (data.message?.status === "success") {
          const result = data.message;
          showSuccess(
            `Quiz submitted successfully! Score: ${result.score}/100 (${result.percentage.toFixed(1)}%) - ${result.passed ? "Passed" : "Failed"}`
          );
          showQuizResult(result);
          
          // Disable submit button
          setSubmitLoading(false);
        } else {
          showError(data.message?.message || "Failed to submit quiz");
          setSubmitLoading(false);
        }
      })
      .catch((err) => {
        showLoading(false);
        console.error("Error submitting quiz:", err);
        showError("Error submitting quiz. Please try again. Check browser console for details.");
        setSubmitLoading(false);
      });
  }

  function goBackToQuizList() {
    // Remove quiz container
    const quizContainer = document.getElementById("quizAttemptContainer");
    if (quizContainer) {
      quizContainer.remove();
    }

    quizAttemptState = null;

    const mainContainer = document.getElementById("mainQuizContainer");
    if (mainContainer) {
      mainContainer.style.display = "block";
    }
    
    // Show form and quiz list again
    document.getElementById("quizForm").style.display = "block";
    if (document.getElementById("quizList").style.display !== "none") {
      document.getElementById("quizList").style.display = "block";
    }
  }

  function setSubmitLoading(isLoading) {
    const submitBtn = document.getElementById("submitQuizBtn");
    if (!submitBtn) return;
    const submitText = submitBtn.querySelector(".submit-text");
    const loading = submitBtn.querySelector(".loading");
    if (isLoading) {
      submitBtn.disabled = true;
      if (submitText) submitText.style.display = "none";
      if (loading) loading.style.display = "inline-block";
    } else {
      submitBtn.disabled = false;
      if (submitText) submitText.style.display = "inline-block";
      if (loading) loading.style.display = "none";
    }
  }
  function showQuizResult(result) {
    const quizContent = document.getElementById("quizContent");
    if (!quizContent) return;

    quizContent.innerHTML = `
      <div class="text-center p-4 result-card">
        <i class="fas fa-clipboard-check fa-3x mb-3 text-success"></i>
        <h3>Quiz Submitted</h3>
        <p class="mb-2"><strong>Score:</strong> ${result.score}/100</p>
        <p class="mb-2"><strong>Percentage:</strong> ${result.percentage.toFixed(1)}%</p>
        <p class="mb-4"><strong>Status:</strong> ${result.passed ? "Passed" : "Failed"}</p>
        <button class="btn btn-secondary" onclick="goBackToQuizList()">
          <i class="fas fa-arrow-left me-2"></i>Back to Quiz List
        </button>
      </div>
    `;
  }
</script>

</body>
</html>
